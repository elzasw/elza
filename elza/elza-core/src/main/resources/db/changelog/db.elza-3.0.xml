<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <changeSet id="20230315100801" author="pasek">
        <validCheckSum>9:fe337f37598c082713e8e78b7f24a31a</validCheckSum>
        <renameColumn tableName="usr_authentication" oldColumnName="value" newColumnName="auth_value"/>
        <renameColumn tableName="ap_rev_index" oldColumnName="value" newColumnName="rev_value"/>
        <renameColumn tableName="arr_data_integer" oldColumnName="value" newColumnName="integer_value"/>
        <renameColumn tableName="ap_index" oldColumnName="value" newColumnName="index_value"/>
        <renameColumn tableName="ap_binding" oldColumnName="value" newColumnName="binding_value"/>
        <renameColumn tableName="ap_binding_item" oldColumnName="value" newColumnName="item_value"/>
        <renameColumn tableName="ap_key_value" oldColumnName="value" newColumnName="key_value"/>
        <renameColumn tableName="arr_data_json_table" oldColumnName="value" newColumnName="data_value"/>
        <renameColumn tableName="ui_settings" oldColumnName="value" newColumnName="settings_value"/>
        <renameColumn tableName="arr_data_coordinates" oldColumnName="value" newColumnName="coordinates_value"/>
        <renameColumn tableName="arr_data_date" oldColumnName="value" newColumnName="date_value"/>
        <renameColumn tableName="arr_data_decimal" oldColumnName="value" newColumnName="decimal_value"/>
        <renameColumn tableName="arr_structured_object" oldColumnName="value" newColumnName="object_value"/>
        <renameColumn tableName="arr_data_string" oldColumnName="value" newColumnName="string_value"/>
        <renameColumn tableName="arr_data_text" oldColumnName="value" newColumnName="text_value"/>
        <renameColumn tableName="arr_data_unitid" oldColumnName="value" newColumnName="unit_value"/>
        <renameColumn tableName="arr_data_uri_ref" oldColumnName="value" newColumnName="uri_ref_value"/>
        <renameColumn tableName="arr_data_bit" oldColumnName="value" newColumnName="bit_value"/>
        <!-- Je nutná úplná aktualizace cache -->
        <delete tableName="ap_cached_access_point"/>
		<delete tableName="arr_cached_node"/>
		<!-- Čištění složky s indexovými soubory lucene/indexes -->
        <customChange class="cz.tacr.elza.dbchangelog.DbChangeset20230315100801"/>
    </changeSet>

    <changeSet id="20240304112900" author="sergey.iryupin">
    	<createTable tableName="hsearch_agent">
    		<column name="assigned_shard_index" type="int" />
    		<column name="total_shard_count" type="int" />
            <column name="expiration" type="timestamptz">
                <constraints nullable="false"/>
            </column>
            <column name="id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="state" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="tenant_id" type="varchar(255)" />
            <column name="type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="bytea" />
    	</createTable>
    	<createTable tableName="hsearch_outbox_event">
    		<column name="entity_id_hash" type="int" />
    		<column name="retries" type="int" />
            <column name="process_after" type="timestamptz">
                <constraints nullable="false"/>
            </column>
            <column name="id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="entity_id" type="varchar(256)" />
            <column name="entity_name" type="varchar(256)" />
            <column name="status" type="varchar(256)" />
            <column name="tenant_id" type="varchar(255)" />
            <column name="payload" type="bytea" />
    	</createTable>
    </changeSet>

    <changeSet id="20240424101900" author="sergey.iryupin">
        <validCheckSum>9:1882606d24b988cf0ebfdf2fedc3ecce</validCheckSum>
    	<createTable tableName="arr_inhibited_item">
    		<column name="inhibited_item_id" type="int">
    			<constraints primaryKey="true" primaryKeyName="pk_arr_inhibited_item" nullable="false"/>
    		</column>
    		<column name="node_id" type="int">
    			<constraints nullable="false" foreignKeyName="fk_inhibited_item_node" 
    						 referencedTableName="arr_node" referencedColumnNames="node_id"/>
			</column>
    		<column name="desc_item_id" type="int">
                <constraints nullable="false" foreignKeyName="fk_inhibited_desc_item_desc_item"
                             referencedTableName="arr_desc_item"
                             referencedColumnNames="item_id"/>
			</column>
    		<column name="create_change_id" type="int">
                <constraints nullable="false" foreignKeyName="fk_inhibited_item_create_change"
                             referencedTableName="arr_change" referencedColumnNames="change_id"/>
    		</column>
    		<column name="delete_change_id" type="int">
                <constraints nullable="true" foreignKeyName="fk_inhibited_item_delete_change"
                             referencedTableName="arr_change" referencedColumnNames="change_id"/>
    		</column>
		</createTable>    
        <createIndex indexName="arr_inhibited_item_node_id_idx" tableName="arr_inhibited_item" unique="false">
            <column name="node_id" type="int"/>
        </createIndex>
    </changeSet>

    <changeSet id="20240606142800" author="sergey.iryupin">
        <validCheckSum>9:f295599a8d1c8d449ff855b0d0d6ac02</validCheckSum>
        <dropColumn tableName="arr_inhibited_item" columnName="desc_item_id"/>
        <addColumn tableName="arr_inhibited_item">
            <column name="desc_item_object_id" type="int">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <sql dbms="postgresql">CREATE UNIQUE INDEX arr_inhibited_item_desc_item_object_pidx
                               ON arr_inhibited_item(desc_item_object_id, node_id)
                               WHERE delete_change_id IS NULL</sql>
	</changeSet>

	<changeSet id="20240703120300" author="sergey.iryupin">
		<validCheckSum>9:dc195ae148efb804944000f967bb19cf</validCheckSum>
		<dropUniqueConstraint tableName="arr_item" constraintName="arr_item_create_change_obj_unqct"/>
		<sql dbms="postgresql">DROP INDEX IF EXISTS arr_item_create_change_idx</sql>
		<sql dbms="postgresql">DROP INDEX IF EXISTS arr_item_delete_change_idx</sql>
		<sql dbms="postgresql">DROP INDEX IF EXISTS arr_item_data_idx</sql>
		<dropIndex tableName="arr_item" indexName="arr_item_dscitemobj_delchng_idx"/>
		<dropIndex tableName="arr_item" indexName="arr_item_type_spec_idx"/>
		<createIndex tableName="arr_item" indexName="arr_item_desc_item_obj_idx"><column name="desc_item_object_id"/></createIndex>
		<createIndex tableName="arr_item" indexName="arr_item_desc_item_obj_create_change_delete_change_idx">
			<column name="desc_item_object_id"/>
			<column name="create_change_id"/>
			<column name="delete_change_id"/>
		</createIndex>
		<!-- TODO: dočasně deaktivujte tento index, abyste se rozhodli, zda je potřeba -->
		<!--<createIndex tableName="arr_item" indexName="arr_item_data_unique_idx" unique="true"><column name="data_id"/></createIndex>-->
		<!-- TODO: ALTER INDEX old_name RENAME TO new_name -->
		<sql dbms="postgresql">DROP INDEX IF EXISTS arr_item_object_pidx</sql>
		<sql dbms="postgresql">CREATE UNIQUE INDEX arr_item_desc_item_obj_delete_change_null_unique_idx ON arr_item(desc_item_object_id) WHERE delete_change_id IS NULL</sql>
        <addUniqueConstraint tableName="arr_item" columnNames="desc_item_object_id, create_change_id" constraintName="arr_item_desc_item_obj_create_change_unique_ct"/>
		<addUniqueConstraint tableName="arr_item" columnNames="desc_item_object_id, delete_change_id" constraintName="arr_item_desc_item_obj_delete_change_unique_ct"/>
	</changeSet>

	<changeSet id="20240722124700" author="sergey.iryupin">
		<!-- přejmenování klíčů po přejmenování tabulek -->
		<sql dbms="postgresql">ALTER INDEX IF EXISTS ap_external_id_pkey RENAME TO ap_binding_pkey</sql>
		<sql dbms="postgresql">ALTER INDEX IF EXISTS ap_fragment_pkey RENAME TO ap_part_pkey</sql>
	</changeSet>
	
	<changeSet id="20240310112200" author="ppy">
		<!-- 9142 - Aktualizace záznamu v Cache po změně napojení entity -->
		<sql> DELETE FROM ap_cached_access_point WHERE access_point_id IN (SELECT bs.access_point_id FROM ap_binding_state bs WHERE bs.delete_change_id is null AND bs.sync_ok='NOT_SYNCED')</sql>
	</changeSet>

</databaseChangeLog>
