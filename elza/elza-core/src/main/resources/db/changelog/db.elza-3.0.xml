<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <changeSet id="20230315100801" author="pasek">
        <validCheckSum>ANY</validCheckSum>
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="usr_authentication" columnName="value"/>
        </preConditions>
        <renameColumn tableName="usr_authentication" oldColumnName="value" newColumnName="auth_value"/>
    </changeSet>
    <changeSet id="20230315100802" author="pasek">
        <renameColumn tableName="ap_rev_index" oldColumnName="value" newColumnName="rev_value"/>
    </changeSet>
    <changeSet id="20230315100803" author="pasek">
        <renameColumn tableName="arr_data_integer" oldColumnName="value" newColumnName="integer_value"/>
    </changeSet>
    <changeSet id="20230315100804" author="pasek">
        <renameColumn tableName="ap_index" oldColumnName="value" newColumnName="index_value"/>
    </changeSet>
    <changeSet id="20230315100805" author="pasek">
        <renameColumn tableName="ap_binding" oldColumnName="value" newColumnName="binding_value"/>
    </changeSet>
    <changeSet id="20230315100806" author="pasek">
        <renameColumn tableName="ap_binding_item" oldColumnName="value" newColumnName="item_value"/>
    </changeSet>
    <changeSet id="20230315100807" author="pasek">
        <renameColumn tableName="ap_key_value" oldColumnName="value" newColumnName="key_value"/>
    </changeSet>
    <changeSet id="20230315100808" author="pasek">
        <renameColumn tableName="arr_data_json_table" oldColumnName="value" newColumnName="data_value"/>
    </changeSet>
    <changeSet id="20230315100809" author="pasek">
        <renameColumn tableName="ui_settings" oldColumnName="value" newColumnName="settings_value"/>
    </changeSet>
    <changeSet id="20230315100810" author="pasek">
        <renameColumn tableName="arr_data_coordinates" oldColumnName="value" newColumnName="coordinates_value"/>
    </changeSet>
    <changeSet id="20230315100811" author="pasek">
        <renameColumn tableName="arr_data_date" oldColumnName="value" newColumnName="date_value"/>
    </changeSet>
    <changeSet id="20230315100812" author="pasek">
        <renameColumn tableName="arr_data_decimal" oldColumnName="value" newColumnName="decimal_value"/>
    </changeSet>
    <changeSet id="20230315100813" author="pasek">
        <renameColumn tableName="arr_structured_object" oldColumnName="value" newColumnName="object_value"/>
    </changeSet>

	<!-- TODO refine the algorithm for next_val
    <changeSet id="20231219133600" author="sergey.iryupin">
    	<sql>UPDATE db_hibernate_sequences SET next_val = next_val + 20 WHERE next_val &lt; 20</sql>
    </changeSet>-->

    <changeSet id="20240304112900" author="sergey.iryupin">
    	<createTable tableName="hsearch_agent">
    		<column name="assigned_shard_index" type="int" />
    		<column name="total_shard_count" type="int" />
            <column name="expiration" type="timestamptz">
                <constraints nullable="false"/>
            </column>
            <column name="id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="state" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="tenant_id" type="varchar(255)" />
            <column name="type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="bytea" />
    	</createTable>
    	<createTable tableName="hsearch_outbox_event">
    		<column name="entity_id_hash" type="int" />
    		<column name="retries" type="int" />
            <column name="process_after" type="timestamptz">
                <constraints nullable="false"/>
            </column>
            <column name="id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="entity_id" type="varchar(256)" />
            <column name="entity_name" type="varchar(256)" />
            <column name="status" type="varchar(256)" />
            <column name="tenant_id" type="varchar(255)" />
            <column name="payload" type="bytea" />
    	</createTable>
    </changeSet>

    <changeSet id="20240424101900" author="sergey.iryupin">
        <validCheckSum>9:1882606d24b988cf0ebfdf2fedc3ecce</validCheckSum>
    	<createTable tableName="arr_inhibited_item">
    		<column name="inhibited_item_id" type="int">
    			<constraints primaryKey="true" primaryKeyName="pk_arr_inhibited_item" nullable="false"/>
    		</column>
    		<column name="node_id" type="int">
    			<constraints nullable="false" foreignKeyName="fk_inhibited_item_node" 
    						 referencedTableName="arr_node" referencedColumnNames="node_id"/>
			</column>
    		<column name="desc_item_id" type="int">
                <constraints nullable="false" foreignKeyName="fk_inhibited_desc_item_desc_item"
                             referencedTableName="arr_desc_item"
                             referencedColumnNames="item_id"/>
			</column>
    		<column name="create_change_id" type="int">
                <constraints nullable="false" foreignKeyName="fk_inhibited_item_create_change"
                             referencedTableName="arr_change" referencedColumnNames="change_id"/>
    		</column>
    		<column name="delete_change_id" type="int">
                <constraints nullable="true" foreignKeyName="fk_inhibited_item_delete_change"
                             referencedTableName="arr_change" referencedColumnNames="change_id"/>
    		</column>
		</createTable>    
        <createIndex indexName="arr_inhibited_item_node_id_idx" tableName="arr_inhibited_item" unique="false">
            <column name="node_id" type="int"/>
        </createIndex>
    </changeSet>

    <changeSet id="20240606142800" author="sergey.iryupin">
        <validCheckSum>9:f295599a8d1c8d449ff855b0d0d6ac02</validCheckSum>
        <dropColumn tableName="arr_inhibited_item" columnName="desc_item_id"/>
        <addColumn tableName="arr_inhibited_item">
            <column name="desc_item_object_id" type="int">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <sql dbms="postgresql">CREATE UNIQUE INDEX arr_inhibited_item_desc_item_object_pidx
                               ON arr_inhibited_item(desc_item_object_id, node_id)
                               WHERE delete_change_id IS NULL</sql>
	</changeSet>

</databaseChangeLog>
