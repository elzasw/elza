<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <changeSet id="16" author="slapa">

        <!--
            par_institution_type
        -->

        <createTable tableName="par_institution_type">
            <column name="institution_type_id" type="int">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="varchar(250)">
                <constraints nullable="false"/>
            </column>
            <column name="code" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <insert tableName="par_institution_type" >
            <column name="institution_type_id" value="1" />
            <column name="code" value="DEFAULT" />
            <column name="name" value="Výchozí" />
        </insert>

        <insert tableName="db_hibernate_sequences">
            <column name="sequence_name" value="par_institution_type|institution_type_id"/>
            <column name="next_val" value="2"/>
        </insert>

        <!--
            par_institution
        -->

        <createTable tableName="par_institution">
            <column name="institution_id" type="int">
                <constraints primaryKey="true"/>
            </column>
            <column name="party_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="institution_type_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="code" type="varchar(50)">
                <constraints unique="true" nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="fk_institution_institutionType"
                                 baseTableName="par_institution"
                                 baseColumnNames="institution_type_id"
                                 referencedTableName="par_institution_type"
                                 referencedColumnNames="institution_type_id"
                                 onDelete="NO ACTION"/>

        <addForeignKeyConstraint constraintName="fk_institution_party"
                                 baseTableName="par_party"
                                 baseColumnNames="party_id"
                                 referencedTableName="par_party"
                                 referencedColumnNames="party_id"
                                 onDelete="NO ACTION"/>

        <insert tableName="db_hibernate_sequences">
            <column name="sequence_name" value="par_institution|institution_id"/>
            <column name="next_val" value="1"/>
        </insert>

        <!--
            arr_fund
        -->

        <addColumn tableName="arr_fund">
            <column name="internal_code" type="varchar(250)">
                <constraints nullable="false"/>
            </column>
            <column name="institution_id" type="int">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addForeignKeyConstraint constraintName="fk_fund_institution"
                                 baseTableName="arr_fund"
                                 baseColumnNames="institution_id"
                                 referencedTableName="par_institution"
                                 referencedColumnNames="institution_id"
                                 onDelete="NO ACTION"/>

        <!--
            arr_fund_version
        -->

        <dropColumn columnName="arrangement_type_id" tableName="arr_fund_version"/>

        <addColumn tableName="arr_fund_version">
            <column name="date_range" type="text" />
        </addColumn>

    </changeSet>

</databaseChangeLog>