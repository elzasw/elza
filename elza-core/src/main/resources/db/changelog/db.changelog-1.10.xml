<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <!--Verze 1.10 - evidence archivních obalů -->
    <changeSet id="11" author="vavrejn" >

        <createTable tableName="arr_packet_type">
            <column name="packet_type_id" type="int">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="code" type="varchar(50)">
                <constraints nullable="false" />
            </column>
            <column name="name" type="varchar(250)">
                <constraints nullable="false" />
            </column>
            <column name="shortcut" type="varchar(50)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addUniqueConstraint tableName="arr_packet_type" columnNames="code" constraintName="u_arr_packet_type_code"/>

        <createTable tableName="arr_packet">
            <column name="packet_id" type="int">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="storage_number" type="varchar(50)">
                <constraints nullable="false" />
            </column>
            <column name="invalid_packet" type="boolean">
                <constraints nullable="false" />
            </column>
            <column name="packet_type_id" type="int">
                <constraints nullable="true" />
            </column>
            <column name="finding_aid_id" type="int">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="arr_data_packet_ref">
            <column name="data_id" type="int">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="packet_id" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="fk_packet_packetType"
                                 baseTableName="arr_packet"
                                 baseColumnNames="packet_type_id"
                                 referencedTableName="arr_packet_type"
                                 referencedColumnNames="packet_type_id"
                                 onDelete="NO ACTION"/>
        <addForeignKeyConstraint constraintName="fk_packet_findingAid"
                                 baseTableName="arr_packet"
                                 baseColumnNames="finding_aid_id"
                                 referencedTableName="arr_finding_aid"
                                 referencedColumnNames="finding_aid_id"
                                 onDelete="NO ACTION"/>
        <addForeignKeyConstraint constraintName="fk_packetRef_data"
                                 baseTableName="arr_data_packet_ref"
                                 baseColumnNames="data_id"
                                 referencedTableName="arr_data"
                                 referencedColumnNames="data_id"
                                 onDelete="NO ACTION"/>
        <addForeignKeyConstraint constraintName="fk_packetRef_packet"
                                 baseTableName="arr_data_packet_ref"
                                 baseColumnNames="packet_id"
                                 referencedTableName="arr_packet"
                                 referencedColumnNames="packet_id"
                                 onDelete="NO ACTION"/>

        <insert tableName="arr_packet_type">
            <column name="packet_type_id" value="1"/>
            <column name="code" value="BOX"/>
            <column name="name" value="Karton"/>
            <column name="shortcut" value="kar"/>
        </insert>
        <insert tableName="arr_packet_type">
            <column name="packet_type_id" value="2"/>
            <column name="code" value="FASCICLE"/>
            <column name="name" value="Fascikl"/>
            <column name="shortcut" value="fas"/>
        </insert>
        <insert tableName="arr_packet_type">
            <column name="packet_type_id" value="3"/>
            <column name="code" value="DATA_UNIT"/>
            <column name="name" value="Digitální archivní jednotka"/>
            <column name="shortcut" value="daj"/>
        </insert>
        <insert tableName="db_hibernate_sequences">
            <column name="sequence_name" value="arr_packet_type|packet_type_id"/>
            <column name="next_val" value="4"/>
        </insert>

        <insert tableName="rul_data_type">
            <column name="data_type_id" value="11"/>
            <column name="code" value="PACKET_REF"/>
            <column name="name" value="Odkaz na obal"/>
            <column name="description" value="Odkaz na obal"/>
            <column name="regexp_use" value="false"/>
            <column name="text_lenght_limit_use" value="false"/>
            <column name="storage_table" value="arr_data_packet_ref"/>
        </insert>

        <update tableName="db_hibernate_sequences">
            <column name="next_val" value="12"/>
            <where>sequence_name = 'rul_data_type|data_type_id'</where>
        </update>
        <update tableName="rul_desc_item_type">
            <column name="data_type_id" value="11"/>
            <where>code = 'ZP2015_STORAGE_ID'</where>
        </update>
    </changeSet>

</databaseChangeLog>
