<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <changeSet id="13" author="slapa">
        <validCheckSum>7:0dfeb2689eed7bf82dd3db68fbb70147</validCheckSum>

        <!-- Table -->

        <renameTable newTableName="arr_fund"
                     oldTableName="arr_finding_aid" />

        <renameTable newTableName="arr_fund_version"
                     oldTableName="arr_finding_aid_version" />

        <renameTable newTableName="arr_fund_register_scope"
                     oldTableName="arr_fa_register_scope" />

        <!-- PK -->

        <renameColumn newColumnName="fund_id"
                      oldColumnName="finding_aid_id"
                      tableName="arr_fund"/>

        <renameColumn newColumnName="fund_version_id"
                      oldColumnName="finding_aid_version_id"
                      tableName="arr_fund_version"/>

        <renameColumn newColumnName="fund_register_scope_id"
                      oldColumnName="fa_register_scope_id"
                      tableName="arr_fund_register_scope"/>

        <!-- FK -->

        <renameColumn newColumnName="fund_id"
                      oldColumnName="finding_aid_id"
                      tableName="arr_fund_version"/>

        <renameColumn newColumnName="fund_id"
                      oldColumnName="finding_aid_id"
                      tableName="arr_fund_register_scope"/>

        <renameColumn newColumnName="fund_id"
                      oldColumnName="finding_aid_id"
                      tableName="arr_packet"/>

        <renameColumn newColumnName="fund_version_id"
                      oldColumnName="finding_aid_version_id"
                      tableName="rul_desc_item_constraint"/>

        <renameColumn newColumnName="fund_version_id"
                      oldColumnName="version_id"
                      tableName="arr_bulk_action_run"/>

        <renameColumn newColumnName="fund_version_id"
                      oldColumnName="version_id"
                      tableName="arr_version_conformity"/>

        <renameColumn newColumnName="fund_version_id"
                      oldColumnName="fa_version_id"
                      tableName="arr_node_conformity"/>

        <renameColumn newColumnName="last_change_id"
                      oldColumnName="last_arr_fa_change_id"
                      tableName="arr_fund_version"/>


        <!--
        <addForeignKeyConstraint constraintName="fk_faVersion_level"
                                         baseTableName="arr_finding_aid_version"
        -->
        <dropForeignKeyConstraint baseTableName="arr_fund_version" constraintName="fk_faVersion_level"/>
        <dropColumn columnName="root_level_id" tableName="arr_fund_version"/>

        <addColumn tableName="arr_fund_version">
            <column name="root_node_id" type="int">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addForeignKeyConstraint constraintName="fk_fundVersion_node"
                                 baseTableName="arr_fund_version"
                                 baseColumnNames="root_node_id"
                                 referencedTableName="arr_node"
                                 referencedColumnNames="node_id"
                                 onDelete="NO ACTION"/>

    </changeSet>

</databaseChangeLog>
