<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <changeSet id="201709150906" author="slapa">
        <createTable tableName="rul_package_dependency">
            <column name="package_dependency_id" type="int">
                <constraints primaryKey="true"/>
            </column>
            <column name="source_package_id" type="int">
                <constraints nullable="false" foreignKeyName="fk_rul_package_source_package" referencedTableName="rul_package"
                             referencedColumnNames="package_id"/>
            </column>
            <column name="target_package_id" type="int">
                <constraints nullable="false" foreignKeyName="fk_rul_package_target_package" referencedTableName="rul_package"
                             referencedColumnNames="package_id"/>
            </column>
            <column name="min_version" type="int">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="201709180951" author="slapa">
        <!-- Přidání nullable vazeb na pravidla -->
        <addColumn tableName="rul_item_type">
            <column name="rule_set_id" type="int" />
        </addColumn>
        <addColumn tableName="rul_output_type">
            <column name="rule_set_id" type="int" />
        </addColumn>
        <addColumn tableName="rul_action">
            <column name="rule_set_id" type="int" />
        </addColumn>
        <addColumn tableName="rul_packet_type">
            <column name="rule_set_id" type="int" />
        </addColumn>
    </changeSet>

    <!-- Migrate current data and set rule_set_id -->
    <changeSet id="20171109074901" author="slapa">

        <!-- Postgresql -->
        <sql dbms="postgresql">UPDATE rul_item_type SET rule_set_id = rs.rule_set_id FROM rul_rule_set rs WHERE rs.package_id = rul_item_type.package_id</sql>
        <sql dbms="postgresql">UPDATE rul_output_type SET rule_set_id = rs.rule_set_id FROM rul_rule_set rs WHERE rs.package_id = rul_output_type.package_id</sql>
        <sql dbms="postgresql">UPDATE rul_action SET rule_set_id = rs.rule_set_id FROM rul_rule_set rs WHERE rs.package_id = rul_action.package_id</sql>
        <sql dbms="postgresql">UPDATE rul_packet_type SET rule_set_id = rs.rule_set_id FROM rul_rule_set rs WHERE rs.package_id = rul_packet_type.package_id</sql>

        <!-- Mssql -->
        <sql dbms="mssql">UPDATE rit SET rule_set_id = rs.rule_set_id FROM rul_item_type rit, rul_rule_set rs WHERE rs.package_id = rul_item_type.package_id</sql>
        <sql dbms="mssql">UPDATE rot SET rule_set_id = rs.rule_set_id FROM rul_output_type rot, rul_rule_set rs WHERE rs.package_id = rul_output_type.package_id</sql>
        <sql dbms="mssql">UPDATE ra SET rule_set_id = rs.rule_set_id FROM rul_action ra, rul_rule_set rs WHERE rs.package_id = rul_action.package_id</sql>
        <sql dbms="mssql">UPDATE rpt SET rule_set_id = rs.rule_set_id FROM rul_packet_type rpt, rul_rule_set rs WHERE rs.package_id = rul_packet_type.package_id</sql>

        <!-- H2 -->
        <sql dbms="h2">UPDATE rul_item_type SET rule_set_id = (SELECT rs.rule_set_id FROM rul_rule_set rs WHERE rs.package_id = rul_item_type.package_id)</sql>
        <sql dbms="h2">UPDATE rul_output_type SET rule_set_id = (SELECT rs.rule_set_id FROM rul_rule_set rs WHERE rs.package_id = rul_output_type.package_id)</sql>
        <sql dbms="h2">UPDATE rul_action SET rule_set_id = (SELECT rs.rule_set_id FROM rul_rule_set rs WHERE rs.package_id = rul_action.package_id)</sql>
        <sql dbms="h2">UPDATE rul_packet_type SET rule_set_id = (SELECT rs.rule_set_id FROM rul_rule_set rs WHERE rs.package_id = rul_packet_type.package_id)</sql>
    </changeSet>

    <changeSet id="201709181003" author="slapa">
        <!-- odstranění typů obalů -->
        <sql>DELETE FROM rul_packet_type WHERE rule_set_id IS NULL</sql>
    </changeSet>

    <!-- Establish constraints on newly created columns (after data migration) -->
    <changeSet id="201709181040" author="slapa">

        <addNotNullConstraint tableName="rul_item_type"
                              columnDataType="int"
                              columnName="rule_set_id"/>
        <addForeignKeyConstraint constraintName="fk_rul_item_type_rul_rule_set"
                                 baseTableName="rul_item_type"
                                 baseColumnNames="rule_set_id"
                                 referencedTableName="rul_rule_set"
                                 referencedColumnNames="rule_set_id"
                                 onDelete="NO ACTION"/>

        <addNotNullConstraint tableName="rul_output_type"
                              columnDataType="int"
                              columnName="rule_set_id"/>
        <addForeignKeyConstraint constraintName="fk_rul_output_type_rul_rule_set"
                                 baseTableName="rul_output_type"
                                 baseColumnNames="rule_set_id"
                                 referencedTableName="rul_rule_set"
                                 referencedColumnNames="rule_set_id"
                                 onDelete="NO ACTION"/>

        <addNotNullConstraint tableName="rul_action"
                              columnDataType="int"
                              columnName="rule_set_id"/>
        <addForeignKeyConstraint constraintName="fk_rul_action_rul_rule_set"
                                 baseTableName="rul_action"
                                 baseColumnNames="rule_set_id"
                                 referencedTableName="rul_rule_set"
                                 referencedColumnNames="rule_set_id"
                                 onDelete="NO ACTION"/>

        <addNotNullConstraint tableName="rul_packet_type"
                              columnDataType="int"
                              columnName="rule_set_id"/>
        <addForeignKeyConstraint constraintName="fk_rul_packet_type_rul_rule_set"
                                 baseTableName="rul_packet_type"
                                 baseColumnNames="rule_set_id"
                                 referencedTableName="rul_rule_set"
                                 referencedColumnNames="rule_set_id"
                                 onDelete="NO ACTION"/>
    </changeSet>

    <changeSet id="201709220800" author="vanek">
        <addColumn tableName="reg_record">
            <column name="invalid" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="201710060957" author="stanekpa">
        <!-- Přidání vazby na spravovane uzivatele a skupiny do permission -->
        <addColumn tableName="usr_permission">
            <column name="user_control_id" type="int" />
            <column name="group_control_id" type="int" />
        </addColumn>

        <addForeignKeyConstraint constraintName="fk_permission_user_control"
                                 baseTableName="usr_permission"
                                 baseColumnNames="user_control_id"
                                 referencedTableName="usr_user"
                                 referencedColumnNames="user_id"
                                 onDelete="NO ACTION"/>

        <addForeignKeyConstraint constraintName="fk_permission_group_control"
                                 baseTableName="usr_permission"
                                 baseColumnNames="group_control_id"
                                 referencedTableName="usr_group"
                                 referencedColumnNames="group_id"
                                 onDelete="NO ACTION"/>
    </changeSet>

    <!-- Pridani indexu na arr_desc_item a arr_item -->
    <changeSet id="201710310000" author="ppyt">
      <createIndex tableName="arr_desc_item" indexName="arr_desc_item_node_idx">
        <column name="node_id" />
      </createIndex>
      <createIndex tableName="arr_item" indexName="arr_item_create_change_idx">
        <column name="create_change_id" />
      </createIndex>
      <createIndex tableName="arr_item" indexName="arr_item_delete_change_idx">
        <column name="delete_change_id" />
      </createIndex>
    </changeSet>

    <!-- Pridani indexu na arr_cached_node -->
    <changeSet id="201711060000" author="ppyt">
      <createIndex tableName="arr_cached_node" indexName="arr_cached_node_node_idx">
        <column name="node_id" />
      </createIndex>
    </changeSet>
    <!-- Add rule_set_id to items in ui_settints with null values -->
    <changeSet id="20171109080301" author="slapa">
        <validCheckSum>7:11aa89e019a75c5fb3d7a5c5b2533323</validCheckSum>

        <sql dbms="postgresql">UPDATE ui_settings SET entity_id = rs.rule_set_id FROM rul_rule_set rs WHERE rs.package_id = ui_settings.package_id AND ui_settings.entity_type = 'RULE' AND ui_settings.entity_id IS NULL</sql>
        <sql dbms="mssql">UPDATE us SET entity_id = rs.rule_set_id FROM ui_settings us, rul_rule_set rs WHERE rs.package_id = ui_settings.package_id AND ui_settings.entity_type = 'RULE' AND ui_settings.entity_id IS NULL</sql>
        <sql dbms="h2">UPDATE ui_settings SET entity_id = (SELECT rs.rule_set_id FROM rul_rule_set rs WHERE rs.package_id = ui_settings.package_id) WHERE ui_settings.entity_type = 'RULE' AND ui_settings.entity_id IS NULL</sql>
    </changeSet>
    
    <!-- added node uuid to cache -> delete current cached nodes -->
    <changeSet id="201711220900" author="jtodt">
        <delete tableName="arr_cached_node" />
    </changeSet>

</databaseChangeLog>
