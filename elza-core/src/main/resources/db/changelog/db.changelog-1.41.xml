<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <changeSet id="42" author="compel">

        <createTable tableName="rul_template">
            <column name="template_id" type="int">
                <constraints primaryKey="true"/>
            </column>
            <column name="output_type_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="package_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="code" type="nvarchar(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="name" type="nvarchar(250)">
                <constraints nullable="false"/>
            </column>
            <column name="engine" type="char(10)">
                <constraints nullable="false"/>
            </column>
            <column name="directory" type="nvarchar(250)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="fk_rulTemplate_rulOutputType"
                                 baseTableName="rul_template"
                                 baseColumnNames="output_type_id"
                                 referencedTableName="rul_output_type"
                                 referencedColumnNames="output_type_id"
                                 onDelete="NO ACTION" />


        <addForeignKeyConstraint constraintName="fk_rulTemplate_rulPackage"
                                 baseTableName="rul_template"
                                 baseColumnNames="package_id"
                                 referencedTableName="rul_package"
                                 referencedColumnNames="package_id"
                                 onDelete="NO ACTION" />

        <addColumn tableName="arr_output_definition">
            <column name="template_id" afterColumn="output_type_id" type="int">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addForeignKeyConstraint constraintName="fk_arrOutputDefinition_rulTemplate"
                                 baseTableName="arr_output_definition"
                                 baseColumnNames="template_id"
                                 referencedTableName="rul_template"
                                 referencedColumnNames="template_id"
                                 onDelete="NO ACTION" />


        <createTable tableName="arr_output_result">
            <column name="output_result_id" type="int">
                <constraints primaryKey="true"/>
            </column>
            <column name="output_definition_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="template_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="change_id" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="fk_arrOutputResult_arrOutputDefinition"
                                 baseTableName="arr_output_result"
                                 baseColumnNames="output_definition_id"
                                 referencedTableName="arr_output_definition"
                                 referencedColumnNames="output_definition_id"
                                 onDelete="NO ACTION" />

        <addForeignKeyConstraint constraintName="fk_arrOutputResult_rulTemplate"
                                 baseTableName="arr_output_result"
                                 baseColumnNames="template_id"
                                 referencedTableName="rul_template"
                                 referencedColumnNames="template_id"
                                 onDelete="NO ACTION" />

        <addForeignKeyConstraint constraintName="fk_arrOutputResult_arrChange"
                                 baseTableName="arr_output_result"
                                 baseColumnNames="change_id"
                                 referencedTableName="arr_change"
                                 referencedColumnNames="change_id"
                                 onDelete="NO ACTION" />

        <createTable tableName="arr_output_file">
            <column name="file_id" type="int">
                <constraints primaryKey="true"/>
            </column>
            <column name="output_result_id" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="fk_arrOutputFile_dmsFile"
                                 baseTableName="arr_output_file"
                                 baseColumnNames="file_id"
                                 referencedTableName="dms_file"
                                 referencedColumnNames="file_id"
                                 onDelete="NO ACTION" />

        <addForeignKeyConstraint constraintName="fk_arrOutputFile_arrOutputResult"
                                 baseTableName="arr_output_file"
                                 baseColumnNames="output_result_id"
                                 referencedTableName="arr_output_result"
                                 referencedColumnNames="output_result_id"
                                 onDelete="NO ACTION" />

    </changeSet>

</databaseChangeLog>
