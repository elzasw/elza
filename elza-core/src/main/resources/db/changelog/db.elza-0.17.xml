<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <changeSet id="20180604102300" author="slapa">
        <renameColumn tableName="rul_item_type" oldColumnName="columns_definition" newColumnName="view_definition" columnDataType="${type.text}" />
    </changeSet>

    <changeSet id="20180601083200" author="slapa">
        <createTable tableName="arr_data_date">
            <column name="data_id" type="int">
                <constraints primaryKey="true"/>
            </column>
            <column name="value" type="date">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="fk_dataDate_data"
                                 baseTableName="arr_data_date"
                                 baseColumnNames="data_id"
                                 referencedTableName="arr_data"
                                 referencedColumnNames="data_id"
                                 onDelete="NO ACTION"/>

        <insert tableName="rul_data_type">
            <column name="data_type_id" value="16"/>
            <column name="code" value="DATE"/>
            <column name="name" value="Datum"/>
            <column name="description" value="Datový typ prvku popisu (Date) pro zadání běžného občanského data"/>
            <column name="regexp_use" value="false"/>
            <column name="text_length_limit_use" value="false"/>
            <column name="storage_table" value="arr_data_date"/>
        </insert>

        <update tableName="db_hibernate_sequences">
            <column name="next_val" value="17"/>
            <where>sequence_name = 'rul_data_type|data_type_id'</where>
        </update>
    </changeSet>

    <changeSet id="20180619072700" author="slapa">
        <dropColumn tableName="rul_item_type" columnName="rule_set_id" />
        <dropColumn tableName="rul_structured_type" columnName="rule_set_id" />
    </changeSet>

    <changeSet id="20180717095200" author="slapa">
        <addColumn tableName="ap_external_id_type">
            <column name="package_id" type="int" />
        </addColumn>
        <sql>UPDATE ap_external_id_type SET package_id = (SELECT package_id FROM rul_package WHERE code = 'CZ_BASE')</sql>
        <addNotNullConstraint tableName="ap_external_id_type" columnName="package_id" columnDataType="int" />
    </changeSet>

    <!-- Column for sort_value in arr_structured_object -->
    <changeSet id="20180903234900" author="ppyt">
        <addColumn tableName="arr_structured_object">
            <column name="sort_value" type="nvarchar(1000)" />
        </addColumn>
        <createIndex tableName="arr_structured_object" indexName="arr_structured_object_sort_idx">
          <column name="sort_value" />
        </createIndex>
        <sql>UPDATE arr_structured_object SET sort_value = value</sql>
    </changeSet>
    
    <!-- New table for structured object queue (value generator) -->
    <changeSet id="20180903234901" author="ppyt">
        <createTable tableName="arr_sobj_vrequest">
            <column name="sobj_vrequest_id" type="int">
                <constraints primaryKey="true"/>
            </column>
            <column name="structured_object_id" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="fk_arr_sobj_vrequest_structured_object"
                                 baseTableName="arr_sobj_vrequest"
                                 baseColumnNames="structured_object_id"
                                 referencedTableName="arr_structured_object"
                                 referencedColumnNames="structured_object_id"
                                 onDelete="NO ACTION"/>
        <insert tableName="db_hibernate_sequences">
            <column name="sequence_name" value="arr_sobj_vrequest|sobj_vrequest_id"/>
            <column name="next_val" value="1"/>
        </insert>
    </changeSet>

    <!-- New table for used values (ref. ozn) -->
    <changeSet id="20180903234902" author="ppyt">
        <createTable tableName="arr_used_value">
            <column name="used_value_id" type="int">
                <constraints primaryKey="true"/>
            </column>
            <column name="fund_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="item_type_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="create_change_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="nvarchar(1000)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="fk_arr_used_value_fund"
                                 baseTableName="arr_used_value"
                                 baseColumnNames="fund_id"
                                 referencedTableName="arr_fund"
                                 referencedColumnNames="fund_id"
                                 onDelete="NO ACTION"/>
        <addForeignKeyConstraint constraintName="fk_arr_used_value_item_type"
                                 baseTableName="arr_used_value"
                                 baseColumnNames="item_type_id"
                                 referencedTableName="rul_item_type"
                                 referencedColumnNames="item_type_id"
                                 onDelete="NO ACTION"/>
        <addForeignKeyConstraint constraintName="fk_arr_used_value_create_change"
                                 baseTableName="arr_used_value"
                                 baseColumnNames="create_change_id"
                                 referencedTableName="arr_change"
                                 referencedColumnNames="change_id"
                                 onDelete="NO ACTION"/>
        <!-- Index pro vyhledavani zaznamu -->
        <createIndex tableName="arr_used_value" indexName="arr_used_value_lookup_idx">
          <column name="fund_id" />
          <column name="item_type_id" />
          <column name="value" />
        </createIndex>

        <insert tableName="db_hibernate_sequences">
            <column name="sequence_name" value="arr_used_value|used_value_id"/>
            <column name="next_val" value="1"/>
        </insert>

    </changeSet>
    <!-- Table for used values (ref. ozn) - remove and change to attribute in arr_item -->
    <changeSet id="20180903234903" author="ppyt">
        <!-- remove data -->
        <delete tableName="arr_used_value" />
        <delete tableName="db_hibernate_sequences">
           <where>sequence_name='arr_used_value|used_value_id'</where>
        </delete>

        <dropForeignKeyConstraint baseTableName="arr_used_value" constraintName="fk_arr_used_value_create_change" />
        <dropForeignKeyConstraint baseTableName="arr_used_value" constraintName="fk_arr_used_value_item_type" />
        <dropForeignKeyConstraint baseTableName="arr_used_value" constraintName="fk_arr_used_value_fund" />
        <dropIndex tableName="arr_used_value" indexName="arr_used_value_lookup_idx"/>

        <dropColumn tableName="arr_used_value" columnName="value" />
        <dropColumn tableName="arr_used_value" columnName="item_type_id" />

        <renameTable newTableName="arr_locked_value" oldTableName="arr_used_value" />
        <renameColumn tableName="arr_locked_value" columnDataType="int"  newColumnName="locked_value_id" oldColumnName="used_value_id"/>

        <!-- Add column for lock -->
        <addColumn tableName="arr_locked_value">
            <column name="item_id" type="int">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addForeignKeyConstraint constraintName="fk_arr_locked_value_fund"
                                 baseTableName="arr_locked_value"
                                 baseColumnNames="fund_id"
                                 referencedTableName="arr_fund"
                                 referencedColumnNames="fund_id"
                                 onDelete="NO ACTION"/>
        <addForeignKeyConstraint constraintName="fk_arr_locked_value_item"
                                 baseTableName="arr_locked_value"
                                 baseColumnNames="item_id"
                                 referencedTableName="arr_item"
                                 referencedColumnNames="item_id"
                                 onDelete="NO ACTION"/>
        <addForeignKeyConstraint constraintName="fk_arr_locked_value_create_change"
                                 baseTableName="arr_locked_value"
                                 baseColumnNames="create_change_id"
                                 referencedTableName="arr_change"
                                 referencedColumnNames="change_id"
                                 onDelete="NO ACTION"/>

        <!-- Indexy pro vyhledavani zaznamu -->
        <createIndex tableName="arr_locked_value" indexName="arr_locked_value_fund_idx">
          <column name="fund_id" />
        </createIndex>
        <createIndex tableName="arr_locked_value" indexName="arr_locked_value_item_idx">
          <column name="item_id" />
        </createIndex>

        <insert tableName="db_hibernate_sequences">
            <column name="sequence_name" value="arr_locked_value|locked_value_id"/>
            <column name="next_val" value="1"/>
        </insert>

        <!-- Index pro vyhledavani nodu -->
        <createIndex tableName="arr_node" indexName="arr_node_fund_idx">
          <column name="fund_id" />
        </createIndex>
    </changeSet>

    <!-- Zneplatneni cache z duvodu zmeny atributu na objektu ArrDataUnitid -->
    <changeSet id="20180903234904" author="ppyt">
        <delete tableName="arr_cached_node" />
    </changeSet>

</databaseChangeLog>
